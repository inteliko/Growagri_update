{% extends 'base.html' %}

{% load static %}

{% block title %}
  Home
{% endblock %}

{% block content %}
 
    <div class="container">

        <h3 class="text-center md-10" >Review Your Project and Make Fund </h3>

      <div class="row">
        <div class="col-md-6"> 


            <div class="card">
                <div class="card-header">
                  Bank Informations 
                </div>
                <div class="card-body">
                  <p class="card-text"> {{ order.bank_name }} </p>
                  <p class="card-text"> {{ order.account_name }} </p>
                  <p class="card-text"> {{ order.account_number }} </p>
                  <p class="card-text"> {{ order.branch_name }} </p>



                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  Paypal Informations
                </div>
                <div class="card-body">
                    <p class="card-text"> {{ order.paypal_account_name }} </p>
                    <p class="card-text"> {{ order.paypal_email }} </p>


                </div>
              </div>

              <div class="card-header">
                Review Projects
              </div>
              <div class="card-body">

                <!-- Project, Quantity, and Amount Table -->
                <table class="table">
                    <thead>
                      <tr>
                        <th>Project</th>
                        <th>Quantity</th>
                        <th>Single Fund</th>
                        <th>Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for cart_item in cart_items %}
                      <tr>
                        <td>{{ cart_item.product.farm_name }}</td>
                        <td>{{ cart_item.quantity }}</td>
                        <td>{{ cart_item.product.price }}</td>
                        <td>{{ cart_item.sub_total }}</td>

                       
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                <!-- Regular Checkout Buttons -->
                
              </div>
            </div>

         
        </div>

        <div class="col-md-4">
          <div class="container">
            <div class="row">
              <div class="col-md-12">
                <div class="card my-5">
                  <div class="container py-2">
                    <div class="row">
                      <div class="col-md- col-sm-12 d-flex justify-content-center flex-column align-items-center">
                        <h3 class="fw-bold">Total</h3>
                        <h4 class="fw-bold " id="total">Total price: {{ total }} </h4> <!-- Display dynamic total -->
                      </div>
                    </div>
                    <!-- Additional content for Return of Investment -->
                    <div class="row mt-3">
                      <div class="col-md-12">
                        <p class="fw-bold text_color">Return of Investment: $500</p>
                      </div>
                    </div>

                    <!-- Buttons -->
                    <div class="row mt-3">
                      <div id="paypal-button-container">



                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Section for Total Price and Return of Investment -->


    <script>
      // Render the PayPal button into #paypal-button-container
      paypal.Buttons({

        style: {
          color:  'blue',
          shape:  'rect',
          label:  'pay',
          height: 40
      },

          // Call your server to set up the transaction
          createOrder: function(data, actions) {
              return fetch('/demo/checkout/api/paypal/order/create/', {
                  method: 'post'
              }).then(function(res) {
                  return res.json();
              }).then(function(orderData) {
                  return orderData.id;
              });
          },

          // Call your server to finalize the transaction
          onApprove: function(data, actions) {
              return fetch('/demo/checkout/api/paypal/order/' + data.orderID + '/capture/', {
                  method: 'post'
              }).then(function(res) {
                  return res.json();
              }).then(function(orderData) {
                  // Three cases to handle:
                  //   (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
                  //   (2) Other non-recoverable errors -> Show a failure message
                  //   (3) Successful transaction -> Show confirmation or thank you

                  // This example reads a v2/checkout/orders capture response, propagated from the server
                  // You could use a different API or structure for your 'orderData'
                  var errorDetail = Array.isArray(orderData.details) && orderData.details[0];

                  if (errorDetail && errorDetail.issue === 'INSTRUMENT_DECLINED') {
                      return actions.restart(); // Recoverable state, per:
                      // https://developer.paypal.com/docs/checkout/integration-features/funding-failure/
                  }

                  if (errorDetail) {
                      var msg = 'Sorry, your transaction could not be processed.';
                      if (errorDetail.description) msg += '\n\n' + errorDetail.description;
                      if (orderData.debug_id) msg += ' (' + orderData.debug_id + ')';
                      return alert(msg); // Show a failure message (try to avoid alerts in production environments)
                  }

                  // Successful capture! For demo purposes:
                  console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                  var transaction = orderData.purchase_units[0].payments.captures[0];
                  alert('Transaction '+ transaction.status + ': ' + transaction.id + '\n\nSee console for all available details');

                  // Replace the above to show a success message within this page, e.g.
                  // const element = document.getElementById('paypal-button-container');
                  // element.innerHTML = '';
                  // element.innerHTML = '<h3>Thank you for your payment!</h3>';
                  // Or go to another URL:  actions.redirect('thank_you.html');
              });
          }

      }).render('#paypal-button-container');
  </script>

{% endblock %}
